<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- The HTML 4.01 Transitional DOCTYPE declaration-->
<!-- above set at the top of the file will set     -->
<!-- the browser's rendering engine into           -->
<!-- "Quirks Mode". Replacing this declaration     -->
<!-- with a "Standards Mode" doctype is supported, -->
<!-- but may lead to some differences in layout.   -->

<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Tangerine">
    <link href='http://fonts.googleapis.com/css?family=Sunshiney' rel='stylesheet' type='text/css'>

  <style>
  
.stickynote {
        width:  200px;
        height: 200px;
        border-top: 1px solid yellow;
        border-left: 1px solid yellow;
        border-bottom: 2px solid gray;
        border-right: 1px solid gray;

        padding: 10px;
        background: #FFFFAA;
        cursor: pointer;


}

.stickynote div.text {
        width:  190px;
        height: 180px;
        font-family: 'Sunshiney', serif;
        font-size: 20px;

        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
}

.stickynote div.edit {
        width:  190px;
        height: 180px;
        display: none;
}

.stickynote div.edit textarea {
            height: 90%;
}

button {
        cursor: pointer;
}

.stickynote button.update {
    border: 1px solid gray;
}

.stickynote button.cancel {
    border: 1px solid red;
    background: #FFAAAA;
}

.hidden { display: none }


div.toolbar {
    position: absolute;
    top: 0px;
    right: 0px;
    background: gray;
}

  </style>
  
  </head>


  <body>
    
  <div class='toolbar'>
   <button id="button-setup-channel">New Note</button>
   &nbsp;
   <button id="button-setup-channel">select</button>
   <input type=text id="input-channel-name" size=20 value="" >
  </div>
   <div class='hidden'>
    <div id='stickynote-sample' class='stickynote' >
        <div class='text'>
        </div>
        <div class='edit'>
            <textarea >
            </textarea>
            <button class='update'>update</button>
            <button class='cancel'>cancel</button>
        </div>
    </div>
   </div>
    <div id="draggables"></div>
    

    <hr>

    <pre id='json'>


   </pre>







    <script>
    var current_folder;
    var current_objects = {};
    function updateStickyNotes(data)  {
            var found_objects = {};

            $(data).each(function() {
                                var name = this.name;
                                var tag = this.tag;
                                found_objects[name] = this;
                                var current = current_objects[name]
                                if ( current && tag == current.tag ) { return;  }
                                var id = "stickynote-" + this.name;
                                var el = $("#"+id);
                                if ( el.length == 0 ) {
                                    el = $("#stickynote-sample").clone(false);
                    				el.attr('id', id );
                					$('#draggables').append( el ); 
                                    el.draggable();
                                    el.find("div.text").bind( "dblclick", function(event, ui) {
                                        el.find("div.text").hide();
                                        el.find("div.edit").show();
                                    } );
                                    el.find("div.edit button.cancel").bind( "click", function(event, ui) {
                                        el.find("div.edit").hide();
                                        el.find("div.text").show();
                                    } );
                                }
                                el.find("div.text").text( this.data.text );
                                el.find("div.edit textarea").val( this.data.text );
                                //el.find("div.edit").hide();
                                //el.find("div.text").show();
                                el.unbind("dragstop");
                                el.bind( "dragstop", function(event, ui) {
                                    storePosition( name, tag, ui.offset.left, ui.offset.top );
                                }); 
                                el.find("div.edit button.update").unbind( "click");
                                el.find("div.edit button.update").bind( "click", function(event, ui) {
                                        storeText( name, tag, el.find("div.edit textarea").val(),
                                               function() {
                                                el.find("div.edit").hide();
                                                el.find("div.text").show();
                                               } );
                                    } );
                                if ( this.meta && this.meta.x && this.meta.y ) {
                                    el.offset( { top: this.meta.y, left: this.meta.x });
                                }
                            }
               );
               for ( var n in current_objects ) {
                       if ( ! found_objects[n] ) {
                            $("#"+"stickynote-"+n).remove();
                            delete current_objects[n];
                       }
               }
               current_objects = found_objects;

    
   }
    







    var xhr = null;
    function setupChannel( observeTag ) {
        if ( xhr ) {
                xhr.abort();
        }
      	xhr = new XMLHttpRequest();
    	xhr.onreadystatechange  =  function()
                                {
                                        if( xhr.readyState == 4 )  {
                                               if ( xhr.status == 200 ) {
                                                    var newtag = parseInt(xhr.responseText);
                                                    setupChannel( newtag );
                                                    if ( newtag != observeTag ) {
        				                                fetchStickyNotes();
                                                    }
                                            } else if (xhr.status != 0 )  {
                                                setTimeout( function() {
                                                            setupChannel( observeTag );
                                                                }, 5000 )
                                            }
                                        }
                                };
                                
    	xhr.open('GET', "../../db/" + current_folder + "/" + "?observe=1&tag="+observeTag, true);
    	xhr.send();
    }

    function storePosition( name, tag, x, y, callback ) {
            var body = JSON.stringify( {
                        x: x,
                        y: y
            });
        jQuery.post( "../../db/" + current_folder + "/" + name + "?meta=1&tag=" + tag, body, function(data) {
                        if (callback) callback();
        } );
    
    }
    function storeText( name, tag, text, callback ) {
            var body = JSON.stringify( { "text": text } );
        jQuery.post( "../../db/" + current_folder + "/" + name + "?meta=0&tag=" + tag, body, function(data) {
                        if (callback) callback();

        } );
    
    }
    
    function fetchStickyNotes() { 
        jQuery.getJSON( "../../db/" + current_folder + "/" , {}, function(data) {
        		$("#json").text( JSON.stringify(data, null, 10 ) );
                updateStickyNotes(data);
        } );
    }
    
    </script>
    <script type="text/javascript" src="../jquery/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="../jquery/jquery-ui-1.8.5.custom.min.js"></script>
    <script type="text/javascript" src="../js/utils.js"></script>
    <script type="text/javascript" >
    	$(function() {
    		$("#button-setup-channel").click( function() {
    				current_folder =  $("#input-channel-name").val(); 
    				setupChannel( 1 ); 
    				fetchStickyNotes();
                    setHashValue("path", current_folder );
    			} );
            current_folder =  getHashValueDefault("path", "root") ;
    	    $("#input-channel-name").val( current_folder );
            setTimeout(  function() {
        		$("#button-setup-channel").click();
                }, 0 );
    	} );
    	
    	
    </script>
    
  </body>
</html>

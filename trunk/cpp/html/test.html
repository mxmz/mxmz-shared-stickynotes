<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- The HTML 4.01 Transitional DOCTYPE declaration-->
<!-- above set at the top of the file will set     -->
<!-- the browser's rendering engine into           -->
<!-- "Quirks Mode". Replacing this declaration     -->
<!-- with a "Standards Mode" doctype is supported, -->
<!-- but may lead to some differences in layout.   -->

<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <style>
  
.stickynote {
        width:  200px;
        height: 200px;
        border-top: 1px solid yellow;
        border-left: 1px solid yellow;
        border-bottom: 2px solid gray;
        border-right: 1px solid gray;

        padding: 10px;
        background: #FFFFAA;
}

  </style>
  
  </head>


  <body>
    
    <input type=text id="input-channel-name" size=20 value="/pippo/" >
    <button id="button-setup-channel">setup</button>
    <pre id='json'>
    </pre>

    <div id="draggables"></div>
    
	









    <script>
    function updateStickyNotes(data, folder)  {

            $(data).each(function() {
                                var name = this.name;
                                var tag = this.tag;
                                var id = "stickynote-" + this.name;
                                var el = $("#"+id);
                                if ( el.length == 0 ) {
                                    el = $('<div></div>');
                    				el.attr('id', id );
                                    el.addClass("stickynote")
                					$('#draggables').append( el ); 
                                    el.draggable();
                                }
                                el.html( this.data.text );
                                el.unbind("dragstop");
                                el.bind( "dragstop", function(event, ui) {
                                    storePosition( folder, name, tag, ui.offset.left, ui.offset.top );
                                }); 
                                if ( this.meta && this.meta.x && this.meta.y ) {
                                    el.offset( { top: this.meta.y, left: this.meta.x });
                                }
                            }
               );

    
   }
    







    var xhr = null;
    function setupChannel(folder, observeTag ) {
        if ( xhr ) {
                xhr.abort();
        }
      	xhr = new XMLHttpRequest();
    	xhr.onreadystatechange  =  function()
                                {
                                        if( xhr.readyState == 4 && xhr.status == 200)
                                        {
                                                    var newtag = parseInt(xhr.responseText);
                                                    setupChannel( folder, newtag );
                                                    if ( newtag != observeTag ) {
        				                                loadStickyNotes( folder );
                                                    }
                                        }
                                };
                                
    	xhr.open('GET', "../../db/" + folder + "/" + "?observe=1&tag="+observeTag, true);
    	xhr.send();
    }

    function storePosition( folder, name, tag, x, y ) {
            var body = JSON.stringify( {
                        x: x,
                        y: y
            });
        jQuery.post( "../../db/" + folder + "/" + name + "?meta=1&tag=" + tag, body, function(data) {
        } );
    
    }
    
    function loadStickyNotes(folder) { 
        jQuery.getJSON( "../../db/" + folder + "/" , {}, function(data) {
        		$("#json").text( JSON.stringify(data, null, 10 ) );
                updateStickyNotes(data,folder);
        } );
    }
    
    </script>
    <script type="text/javascript" src="../jquery/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="../jquery/jquery-ui-1.8.5.custom.min.js"></script>
    <script type="text/javascript" src="../js/utils.js"></script>
    <script type="text/javascript" >
    	$(function() {
    		$("#button-setup-channel").click( function() {
    				setupChannel( $("#input-channel-name").val(), 1 ); 
    				loadStickyNotes( $("#input-channel-name").val() );
                    setHashValue("path", $("#input-channel-name").val() );
    			} );
    	    $("#input-channel-name").val( getHashValueDefault("path", "/") );
    	} );
    	
    	
    </script>
    
  </body>
</html>
